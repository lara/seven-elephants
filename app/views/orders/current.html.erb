<h2>My Shopping Cart</h2>

<div class="order">
  <div class="order-items">
    <table>
      <tr>
        <th colspan="2">Product</th>
        <th>Each</th>
        <th>Quantity</th>
        <th class="item-total">Total</th>
      </tr>

    <% @order_products_with_product.each do |order_product| %>
      <tr>
        <td colspan="2">
          <%= link_to order_product.product.name, order_product.product %>
        </td>
        <td>
          <%= format_price order_product.price %>
        </td>
        <td class="quantity">
          <%= form_for order_product, remote: true do |f| %>
            &times; <%= f.select :quantity, 1..([[order_product.product.stock_quantity, 10].min, order_product.quantity].max) %>
            <%= f.submit %>
          <% end %>
        </td>
        <td class="item-total">
          <%= format_price order_product.total %>
        </td>
        <td class="remove-icon">
          <%= link_to order_product, method: :delete do %>
            <i class="fa fa-trash" aria-hidden="true"></i>
          <% end %>
        </td>
      </tr>
    <% end %>
    </table>
  </div>

  <div class="order-summary">
    <h3>Order Summary</h3>
    <p>Subtotal: <span class="order-total"><%= format_price @order.total %></span></p>
    <p>Estimated Tax: <span class="order-total"><%= format_price 0 %></span></p>
    <h4>Total: <span class="order-total"><%= format_price @order.total %></span></h4>

    <div class="stripe-checkout">
      <%= form_tag charges_path do %>
        <article>
          <% if flash[:error].present? %>
            <div id="error_explanation">
              <p><%= flash[:error] %></p>
            </div>
          <% end %>
        </article>

        <script src="https://checkout.stripe.com/checkout.js" class="stripe-button"
                data-key="<%= Rails.configuration.stripe[:publishable_key] %>"
                data-description="Your Seven Elephants Order"
                data-amount="<%= @order.total %>"
                data-locale="auto"
                data-label="Checkout with Stripe">
        </script>
      <% end %>
    </div>
  </div>
</div>
